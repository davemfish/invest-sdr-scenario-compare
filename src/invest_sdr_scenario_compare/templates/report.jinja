{% from invest_reports_env.get_template('raster-plot-img.html') import raster_plot_img %}
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css"
        />
        <link
            rel="stylesheet"
            href="https://cdn.datatables.net/buttons/3.2.4/css/buttons.dataTables.min.css"
        />
        <script
            src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous">
        </script>
        <script
            src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"
            type="text/javascript">
        </script>
        <script
            src="https://cdn.datatables.net/buttons/3.2.4/js/dataTables.buttons.min.js"
            type="text/javascript">
        </script>
        <script
            src="https://cdn.datatables.net/buttons/3.2.4/js/buttons.colVis.min.js"
            type="text/javascript">
        </script>
        {% block styles %}
            {% include 'style.html' %}
        {% endblock styles %}
    </head>
    <body>
        <h1>InVEST SDR Scenario Comparison Report</h1>
        <p>
            In this report, the baseline scenario was compared
            with each of the other scenarios. The first row of the
            scenarios csv is always treated as the baseline scenario.
        </p>
        {{ scenario_table_html | safe}}
        <hr />
        <h3>Aggregated results by watershed</h3>
        <p> {{ watersheds_data_description }} </p>
        <div id="variable-select-container">
            <label for="variable-select">Filter by variable: </label>
        </div>
        <div>
            {{watersheds_data | safe}}
        </div>
        <script type="text/javascript">
            window.addEventListener('DOMContentLoaded', function () {
                new DataTable('#watersheds', {
                    paging: false,
                    layout: {
                        topStart: null,
                        topEnd: null,
                        bottomStart: {
                            buttons: ['colvis']
                        },
                        bottomEnd: null
                    },
                    autoWidth: false,
                    columnDefs: [
                      {
                        targets: '_all',
                        render: function (data, type, row, meta) {
                            const number = parseFloat(data);
                            let string = data
                            if (!isNaN(number)) {
                                string = number.toLocaleString(
                                    undefined,
                                    {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 2
                                    });
                            }
                            return string;
                        }
                      }
                    ],
                    initComplete: function () {
                        this.api()
                            .columns('variable:title')
                            .every(function () {
                                let column = this;

                                let select = document.createElement('select');
                                select.setAttribute('id', 'variable-select');
                                select.add(new Option(''));
                                document.getElementById('variable-select-container').append(select);
                 
                                select.addEventListener('change', function () {
                                    column
                                        .search(select.value, {exact: true})
                                        .draw();
                                });
                 
                                column
                                    .data()
                                    .unique()
                                    .sort()
                                    .each(function (d, j) {
                                        select.add(new Option(d));
                                    });
                            });
                    }
                });
            });
        </script>
        <hr />
        <h3>Raster Results: Differences from the baseline scenario</h3>
        <p>
            Plots showing "scenario - baseline" for each variable.
        </p>
        {% for key, value in sdr_diff_rasters.items() %}
            <details>
                <summary>{{ key|e }}</summary>
                {{ raster_plot_img(value) }}
            </details>
        {% endfor %}
        <hr />
        <h3>Original SDR raster results across scenarios</h3>
        {% for key, value in sdr_scenario_rasters.items() %}
            <details>
                <summary>{{ key|e }}</summary>
                {{ raster_plot_img(value) }}
            </details>
        {% endfor %}
        <hr />
        <details>
            <summary>Metadata</summary>
            <dl>
            {% for output in model_spec_outputs %}
                <dt>{{ output.path }}</dt>
                <dd><p>{{ output.about }}</p></dd>
                {% if output.units %}
                    <dd>Units: {{ output.units }}</dd>
                {% endif %}
            {% endfor %}
            </dl>
        </details>
    </body>
</html>
